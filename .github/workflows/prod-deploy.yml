name: Production Merge and Deploy

on: workflow_dispatch

env:
    SUPERUSER_TOKEN: ${{ secrets.PESU_DEV_SUPERUSER_TOKEN }}
    ALLOWED_USERS: ${{ vars.PROD_DEPLOYMENT_ALLOWED_USERS }}
    DEPLOYMENT_PATH: ${{ vars.PROD_DEPLOYMENT_PATH }}
    PM2_APP_NAME: ${{ vars.PROD_PM2_APP_NAME }}
    IMAGE_NAME: discord-bot
    IMAGE_TAG: prod                    
    CONTAINER_NAME: discord-bot  


jobs:
    check-permissions:
        name: Check Permissions
        runs-on: ubuntu-latest
        steps:
            - name: Check if user has permissions
              id: check-permissions
              run: |
                  PERMISSION_GRANTED=0
                  IFS=',' read -ra USERS <<< "${{ env.ALLOWED_USERS }}"
                  for user in "${USERS[@]}"; do
                    if [[ "$user" == "${{ github.actor }}" ]]; then
                      PERMISSION_GRANTED=1
                      break
                    fi
                  done
                  if [[ "$PERMISSION_GRANTED" -ne 1 ]]; then
                    echo "‚ùå You do not have permission to trigger this workflow."
                    exit 1
                  fi
                  echo "‚úÖ Permission granted"
                  echo "user=${{ github.actor }}" >> $GITHUB_OUTPUT
                  echo "allowed=true" >> $GITHUB_OUTPUT
    merge:
        name: Merge dev to main
        runs-on: ubuntu-latest
        needs: [check-permissions]
        outputs:
            has_changes: ${{ steps.check-changes.outputs.has_changes }}
            pre_merge_commit: ${{ steps.store-commit.outputs.commit }}
        concurrency:
            group: production-merge
            cancel-in-progress: false
        steps:
            - name: Checkout main branch
              uses: actions/checkout@v4
              with:
                  ref: main
                  token: ${{ env.SUPERUSER_TOKEN }}
                  fetch-depth: 0

            - name: Configure Git
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

            - name: Store current commit before merge
              id: store-commit
              run: |
                  CURRENT_COMMIT=$(git rev-parse HEAD)
                  echo "commit=$CURRENT_COMMIT" >> $GITHUB_OUTPUT
                  echo "üìå Stored pre-merge commit: $CURRENT_COMMIT"

            - name: Fetch latest code from dev branch
              id: check-changes
              run: |
                  set -e
                  git fetch origin dev

                  CHANGES=$(git rev-list main..origin/dev --count)
                  echo "changes=$CHANGES" >> $GITHUB_OUTPUT
                  if [ "$CHANGES" -eq "0" ]; then
                    echo "‚ÑπÔ∏è No new changes to deploy"
                    echo "has_changes=false" >> $GITHUB_OUTPUT
                  else
                    echo "has_changes=true" >> $GITHUB_OUTPUT 
                    echo "üìä Found $CHANGES commits to merge"
                    git log --oneline main..origin/dev
                  fi

            - name: Merge changes
              if: steps.check-changes.outputs.has_changes == 'true'
              run: |
                  git merge --ff origin/dev || {
                    echo "‚ùå Merge conflict detected. Please resolve conflicts manually."
                    git merge --abort
                    exit 1
                  }

            - name: Push changes to main branch
              if: steps.check-changes.outputs.has_changes == 'true'
              run: git push origin main

    build_and_push_image:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout repo
          uses: actions/checkout@v4

        - name: Install GitHub CLI
          uses: cli/cli-action@v2

        - name: Trigger build and push
          env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          run: |
            RUN_ID=$(gh workflow run "Build and Push Docker Image to GHCR" --ref main --json id --jq .id)
            echo "Waiting for build to finish"
            gh run watch $RUN_ID

    deploy:
        name: Deploy image to production
        runs-on: discord-bot-deploy-runner
        needs: merge
        if: needs.merge.result == 'success' && needs.merge.outputs.has_changes == 'true'
        steps:
            - name: GHCR login
              uses: docker/login-action@v3
              with:
                registry: ghcr.io
                username: ${{ github.repository_owner }}
                password: ${{ secrets.GITHUB_TOKEN }}

            - name: Pull latest image
              run: docker pull ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

            - name: Stop and delete old container
              run: |
                if [ "$(docker ps -q -f name=${{ env.CONTAINER_NAME }}-${{ env.IMAGE_TAG }})" ]; then
                  echo "Stopping and removing existing container"
                  docker stop ${{ env.CONTAINER_NAME }}-${{ env.IMAGE_TAG }}
                  docker rm ${{ env.CONTAINER_NAME }}-${{ env.IMAGE_TAG }}
                else
                  echo "No existing container found with name ${{ env.CONTAINER_NAME }}-${{ env.IMAGE_TAG }}"
                fi

            - name: Run new container
              run: |
                docker run -d \
                  --name ${{ env.CONTAINER_NAME }}-${{ env.IMAGE_TAG }} \
                  --restart always \
                  ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}


            - name: Health Check
              run: |
                sleep 10
                if docker ps --filter "name=${{ env.CONTAINER_NAME }}-${{ env.IMAGE_TAG }}" --filter "status=running" --format '{{.Names}}' | grep -q "${{ env.CONTAINER_NAME }}-${{ env.IMAGE_TAG }}"; then
                  echo "Production Container is running successfully"
                else
                  echo "Production Container failed to start"
                  docker logs ${{ env.CONTAINER_NAME }}-${{ env.IMAGE_TAG }} --tail 20
                  exit 1
                fi

    # rollback:
    #     name: Rollback on failure
    #     runs-on: discord-bot-deploy-runner
    #     needs: [merge, deploy]
    #     if: failure() && needs.merge.result == 'success'
    #     steps:
    #         - name: Rollback to pre-merge commit
    #           run: |
    #               cd ${{ env.DEPLOYMENT_PATH }}
    #               PRE_MERGE_COMMIT="${{ needs.merge.outputs.pre_merge_commit }}"
    #               echo "Rolling back to pre-merge commit: $PRE_MERGE_COMMIT"
    #               git reset --hard $PRE_MERGE_COMMIT

    #         - name: Restart with previous version
    #           run: pm2 restart ${{ env.PM2_APP_NAME }}
