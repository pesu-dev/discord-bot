name: Dev Deploy

on:
    push:
        branches:
            - dev

env:
    DEPLOYMENT_PATH: ${{ vars.DEV_DEPLOYMENT_PATH }}
    PM2_APP_NAME: ${{ vars.DEV_PM2_APP_NAME }}
    IMAGE_NAME: discord-bot
    IMAGE_TAG: dev                    
    CONTAINER_NAME: discord-bot  

jobs:

    build_and_push_image:
      uses: ./.github/workflows/build-and-push-image.yml
      with:
        tag: dev

    deploy:
        needs: build_and_push_image
        runs-on: discord-bot-deploy-runner
        steps:
            - name: GHCR login
              uses: docker/login-action@v3
              with:
                registry: ghcr.io
                username: ${{ github.repository_owner }}
                password: ${{ secrets.GITHUB_TOKEN }}

            - name: Pull latest image and restart 
              run: |
                REPO_OWNER=${{ github.repository_owner }} \
                IMAGE_TAG=${{ env.IMAGE_TAG }} \
                docker compose pull

                REPO_OWNER=${{ github.repository_owner }} \
                IMAGE_TAG=${{ env.IMAGE_TAG }} \
                docker compose up -d

            - name: Health Check
              run: |
                sleep 10
                if docker ps --filter "name=${{ env.CONTAINER_NAME }}-${{ env.IMAGE_TAG }}" --filter "status=running" --format '{{.Names}}' | grep -q "${{ env.CONTAINER_NAME }}-${{ env.IMAGE_TAG }}"; then
                  echo "Dev Container is running successfully"
                else
                  echo "Dev Container failed to start"
                  docker logs ${{ env.CONTAINER_NAME }}-${{ env.IMAGE_TAG }} --tail 20
                  exit 1
                fi