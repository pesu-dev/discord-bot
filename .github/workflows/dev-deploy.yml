name: Dev Deploy

on:
    push:
        branches:
            - dev

env:
    DEPLOYMENT_PATH: ${{ vars.DEV_DEPLOYMENT_PATH }}

jobs:

    build_and_push_image:
      uses: ./.github/workflows/build-and-push-image.yml
      with:
        tag: dev

    deploy:
        needs: [build_and_push_image]
        runs-on: discord-bot-deploy-runner
        permissions:
          packages: write
          contents: read
        steps:
            - name: GHCR login
              uses: docker/login-action@v3
              with:
                registry: ghcr.io
                username: ${{ github.repository_owner }}
                password: ${{ secrets.GITHUB_TOKEN }}

            - name: Pull latest image and restart 
              run: |
                cd ${{ env.DEPLOYMENT_PATH }}
                git reset --hard HEAD
                git pull origin dev

                REPO_OWNER=${{ github.repository_owner }} \
                IMAGE_TAG=${{ vars.DEV_DOCKER_IMAGE_TAG }} \
                docker compose pull

                REPO_OWNER=${{ github.repository_owner }} \
                IMAGE_TAG=${{ vars.DEV_DOCKER_IMAGE_TAG }} \
                docker compose up -d

            - name: Health Check
              run: |
                sleep 10
                if docker ps --filter "name=${{ vars.DEV_DOCKER_CONTAINER_NAME }}" --filter "status=running" --format '{{.Names}}' | grep -q "${{ vars.DEV_DOCKER_CONTAINER_NAME }}"; then
                  echo "Dev Container is running successfully"
                else
                  echo "Dev Container failed to start"
                  docker logs ${{ vars.DEV_DOCKER_CONTAINER_NAME }} --tail 20
                  exit 1
                fi